# Phase 4 回归测试清单

## 概述

本文档定义 Phase 4（Adobe Illustrator CEP 集成）的完整回归测试清单，基于需求文档 D8.23。每个必测组合都必须通过本清单中的所有测试项。

**创建日期**：2026-02-24  
**最后更新**：2026-02-24  
**状态**：✅ 已创建

---

## 测试环境准备

### 前置条件

- [ ] Illustrator 已安装并可正常启动
- [ ] CEP 扩展已安装（本地开发模式或 .zxp 安装）
- [ ] PlayerDebugMode 已启用（如需调试）
- [ ] 测试数据已准备（测试公式、测试字体包）

### 测试数据

#### 测试公式集

**基础公式**（Phase 1）：
1. 简单分数：`\frac{a}{b}`
2. 嵌套分数：`\frac{1}{\frac{2}{3}}`
3. 上下标：`x^2 + y_i`
4. 根号：`\sqrt{x+1}`
5. 求和：`\sum_{i=1}^{n} x_i`

**UnicodeMath 公式**（Phase 2）：
1. 简单分数：`a/b`
2. 上下标：`x^2_i`
3. 根号：`√(x+1)`
4. 求和：`∑_(i=1)^n x_i`
5. 歧义场景：`x^2^3`

**字体测试公式**（Phase 3）：
1. 字母数字混合：`A+a+1`
2. 上下标：`A^2+a_1`
3. 分数：`\frac{A}{a}`
4. 根号：`\sqrt{A+a+1}`
5. 复杂表达：`f(x)=\frac{\sum_{i=1}^{n} x_i^2}{\sqrt{n}}`

**字号统一测试公式**（Phase 4）：
1. 简单公式：`x+y=5`
2. 分数：`\frac{a}{b}`
3. 上下标：`x^2_i`
4. 复杂表达：`f(x)=\frac{a+b}{c-d}`

#### 测试字体包

- **默认字体包**：MathJax 默认字体（无需准备）
- **自定义字体包**：`extension/client/dist/fonts/user-font-pack/`（如已配置）

---

## 测试清单

### 1. 基础环境测试

#### 1.1 扩展可见性
- [ ] 打开 Illustrator
- [ ] 菜单栏 > 窗口 > 扩展 > Math Formula Plugin 可见
- [ ] 点击菜单项，面板可打开

**验收标准**：扩展在菜单中可见且可打开

#### 1.2 面板加载
- [ ] 面板打开后不显示空白
- [ ] 面板显示完整 UI（输入框、预览区、按钮）
- [ ] 无 JavaScript 错误（检查 DevTools 控制台）

**验收标准**：面板正常加载，UI 完整显示

#### 1.3 MathJax 加载
- [ ] 在输入框输入简单公式（如 `x+y`）
- [ ] 预览区显示渲染结果
- [ ] 控制台输出 MathJax 版本信息（如有日志）

**验收标准**：MathJax 成功加载并可渲染公式

---

### 2. Phase 1 功能回归测试

#### 2.1 LaTeX 输入与实时预览
- [ ] 输入 `\frac{a}{b}` → 预览显示分数
- [ ] 输入 `x^2 + y_i` → 预览显示上下标
- [ ] 输入 `\sqrt{x+1}` → 预览显示根号
- [ ] 输入 `\sum_{i=1}^{n} x_i` → 预览显示求和
- [ ] 修改输入 → 预览实时更新

**验收标准**：LaTeX 输入可正确渲染，预览实时更新

#### 2.2 SVG 导出功能
- [ ] 输入公式 `\frac{a}{b}`
- [ ] 点击"下载 SVG"按钮
- [ ] SVG 文件成功下载
- [ ] 在浏览器或图像查看器中打开 SVG，显示正确

**验收标准**：SVG 导出功能正常，文件可正常打开

#### 2.3 错误处理
- [ ] 输入无效 LaTeX（如 `\frac{a`）
- [ ] 预览区显示错误提示
- [ ] 错误提示包含错误位置和原因

**验收标准**：错误处理正常，提示信息清晰

---

### 3. Phase 2 功能回归测试

#### 3.1 UnicodeMath 粘贴与转换
- [ ] 粘贴 `a/b` → 自动识别为 UnicodeMath
- [ ] 转换为 LaTeX `\frac{a}{b}` → 预览显示分数
- [ ] 粘贴 `x^2_i` → 转换为 `x^{2}_{i}` → 预览显示上下标
- [ ] 粘贴 `√(x+1)` → 转换为 `\sqrt{x+1}` → 预览显示根号

**验收标准**：UnicodeMath 可正确识别和转换

#### 3.2 歧义处理
- [ ] 粘贴 `x^2^3` → 触发歧义检测
- [ ] 显示多种解析结果对比（如 `x^{2^{3}}` vs `x^{2}^{3}`）
- [ ] 用户可选择其中一种
- [ ] 选择后预览更新

**验收标准**：歧义处理功能正常，用户可选择解析结果

#### 3.3 降级提示
- [ ] 粘贴富文本（如从 Word 复制带格式的文本）
- [ ] 显示降级提示："检测到富文本，请粘贴纯文本"
- [ ] 提示包含操作指引（如何获取纯文本）
- [ ] 原始内容被保留

**验收标准**：降级提示功能正常，提示信息清晰

#### 3.4 格式切换
- [ ] 在格式选择器中切换格式（UnicodeMath / LaTeX / AsciiMath）
- [ ] 预览实时更新
- [ ] 切换后输入新公式，使用选定格式解析

**验收标准**：格式切换功能正常

---

### 4. Phase 3 功能回归测试

#### 4.1 自定义字体包加载
- [ ] 检查字体选择器中"自主字体"选项状态
- [ ] 如果 `user-font-pack/` 存在，选项应可用
- [ ] 如果不存在，选项应禁用并显示提示

**验收标准**：字体包加载状态正确显示

#### 4.2 字体切换与预览
- [ ] 选择"自主字体"
- [ ] 输入 `A+a+1` → 预览中字母数字使用自定义字体
- [ ] 输入 `\alpha + \beta` → 预览中希腊字母保持默认字体
- [ ] 切换回"默认字体" → 预览恢复 MathJax 默认样式

**验收标准**：字体切换功能正常，字母数字受影响，符号不变

#### 4.3 字体包信息显示
- [ ] 选择"自主字体"后，显示字体包信息
- [ ] 信息包含：字体名称、更新时间、失败字形数量（如有）
- [ ] 信息准确无误

**验收标准**：字体包信息正确显示

#### 4.4 字体包轮询机制
- [ ] 使用 Font Pack Builder 工具更新 `user-font-pack/`
- [ ] 等待 2-5 秒（轮询间隔）
- [ ] 面板自动检测到更新并重新加载字体包
- [ ] 预览自动刷新（如有当前公式）

**验收标准**：字体包轮询机制正常工作

---

### 5. Phase 4 插入功能测试

#### 5.1 文档状态检查
- [ ] 关闭所有 Illustrator 文档
- [ ] 点击"插入到 Illustrator"按钮
- [ ] 显示错误提示："请先打开或创建一个 Illustrator 文档"

**验收标准**：无文档时显示错误提示

#### 5.2 SVG 插入功能
- [ ] 创建或打开一个 Illustrator 文档
- [ ] 在面板中输入公式 `\frac{a}{b}`
- [ ] 点击"插入到 Illustrator"按钮
- [ ] 公式成功插入到文档中

**验收标准**：SVG 插入功能正常

#### 5.3 插入对象类型验证
- [ ] 插入公式后，选中插入的对象
- [ ] 检查对象类型：应为 Group 或 PathItems（矢量）
- [ ] 不应为 PlacedItem（链接模式）或 RasterItem（位图）

**验收标准**：插入对象为矢量类型

#### 5.4 插入位置验证
- [ ] 插入公式后，检查插入位置
- [ ] 位置应在当前视图中心（或画板中心）
- [ ] 位置合理，用户可见

**验收标准**：插入位置合理

#### 5.5 插入尺寸验证
- [ ] 插入公式后，选中对象
- [ ] 检查对象宽度：应约为 200pt（等比缩放）
- [ ] 高度应按比例缩放
- [ ] 尺寸合理，不过大或过小

**验收标准**：插入尺寸符合定义（200pt 宽度）

#### 5.6 临时文件清理
- [ ] 插入成功后，检查临时文件目录
- [ ] 临时 SVG 文件应被删除
- [ ] 如果插入失败，临时文件应保留（用于调试）

**验收标准**：临时文件清理策略正确

#### 5.7 三段式导入策略验证
- [ ] 插入公式后，检查日志输出（DevTools 控制台）
- [ ] 日志应显示使用的导入方法（A/B/C）
- [ ] 日志应显示插入的对象数量和类型
- [ ] 方法 A（Open → Copy → Paste）应优先使用

**验收标准**：三段式导入策略正常工作，日志信息完整

---

### 6. Phase 4 字号统一功能测试

#### 6.1 字号统一基础功能
- [ ] 输入公式 `x+y=5`
- [ ] 在字号输入框输入 `14`（表示 14pt）
- [ ] 点击"插入到 Illustrator"
- [ ] 插入的公式字号应为 14pt（em 大小）

**验收标准**：字号统一功能基础可用

#### 6.2 多公式字号一致性
- [ ] 插入公式 `x+y=5`，字号 14pt
- [ ] 插入公式 `\frac{a}{b}`，字号 14pt
- [ ] 插入公式 `x^2_i`，字号 14pt
- [ ] 在 Illustrator 中选中三个公式，检查标尺高度
- [ ] 标尺高度应一致（x-height 相同）

**验收标准**：多公式字号一致性正确

#### 6.3 标尺识别与清理
- [ ] 插入公式后，在 Illustrator 中检查
- [ ] 不应看到标尺残留（tag 和 ruler 应被删除）
- [ ] 公式显示正常，无多余元素

**验收标准**：标尺正确识别并清理

#### 6.4 字号统一失败处理
- [ ] 如果标尺识别失败（marker=none）
- [ ] 应显示错误提示："标尺识别失败，本次未应用字号统一"
- [ ] 不应默默回退到默认宽度缩放

**验收标准**：字号统一失败时显示明确提示

---

### 7. 字体一致性测试（Phase 3 + Phase 4 结合）

#### 7.1 自定义字体在 CEP 中的表现
- [ ] 在 CEP 面板中选择"自主字体"
- [ ] 输入 `A+a+1` → 预览中字母数字使用自定义字体
- [ ] 点击"插入到 Illustrator"
- [ ] 在 Illustrator 中检查插入的公式
- [ ] 字母数字应保持自定义字体效果
- [ ] 符号应保持 MathJax 默认样式

**验收标准**：自定义字体在 CEP 和 Illustrator 中表现一致

#### 7.2 字体切换后插入
- [ ] 选择"自主字体"，插入公式 `A+a+1`
- [ ] 切换回"默认字体"，插入公式 `A+a+1`
- [ ] 在 Illustrator 中对比两个公式
- [ ] 第一个应使用自定义字体，第二个应使用默认字体

**验收标准**：字体切换后插入的公式使用正确字体

---

### 8. 错误处理与边界情况测试

#### 8.1 无效输入处理
- [ ] 输入空字符串 → 显示提示"请输入公式"
- [ ] 输入无效 LaTeX → 显示错误提示
- [ ] 输入超长公式（> 10,000 字符）→ 显示长度限制提示

**验收标准**：无效输入处理正常

#### 8.2 权限不足处理
- [ ] 打开只读文档（如果可模拟）
- [ ] 尝试插入公式
- [ ] 显示错误提示："文档只读，无法插入"

**验收标准**：权限不足时显示错误提示

#### 8.3 ExtendScript 通信失败
- [ ] 模拟 ExtendScript 通信失败（如禁用 ExtendScript）
- [ ] 尝试插入公式
- [ ] 显示错误提示："与 Illustrator 通信失败"

**验收标准**：通信失败时显示错误提示

---

### 9. 性能测试

#### 9.1 面板加载时间
- [ ] 记录面板从打开到完全加载的时间
- [ ] 时间应 < 3 秒

**验收标准**：面板加载时间合理

#### 9.2 公式渲染时间
- [ ] 输入简单公式（如 `x+y`）
- [ ] 记录从输入到预览显示的时间
- [ ] 时间应 < 500ms

**验收标准**：公式渲染时间合理

#### 9.3 插入时间
- [ ] 输入公式并点击"插入到 Illustrator"
- [ ] 记录从点击到插入完成的时间
- [ ] 时间应 < 2 秒

**验收标准**：插入时间合理

#### 9.4 复杂公式性能
- [ ] 输入复杂公式（如 `f(x)=\frac{\sum_{i=1}^{n} x_i^2}{\sqrt{n}}`）
- [ ] 记录渲染和插入时间
- [ ] 时间应在可接受范围内（< 5 秒）

**验收标准**：复杂公式性能可接受

---

### 10. 跨平台兼容性测试（仅适用于多平台测试）

#### 10.1 路径处理
- [ ] 在 Windows 上测试插入功能
- [ ] 检查临时文件路径是否正确（使用正斜杠 `/`）
- [ ] 插入功能正常

**验收标准**：跨平台路径处理正确

#### 10.2 UI 显示
- [ ] 在不同平台上检查 UI 显示
- [ ] 字体、间距、布局应一致
- [ ] 无明显的平台特定问题

**验收标准**：UI 跨平台显示一致

---

## 测试结果记录

### 测试环境信息

| 项目 | 值 |
|------|-----|
| 操作系统 | |
| Illustrator 版本 | |
| 处理器架构 | |
| CEP 版本 | |
| 扩展版本 | |
| 测试日期 | |
| 测试人员 | |

### 测试结果汇总

| 测试类别 | 通过数 | 失败数 | 跳过数 | 通过率 |
|---------|--------|--------|--------|--------|
| 1. 基础环境测试 | | | | |
| 2. Phase 1 功能回归 | | | | |
| 3. Phase 2 功能回归 | | | | |
| 4. Phase 3 功能回归 | | | | |
| 5. Phase 4 插入功能 | | | | |
| 6. 字号统一功能 | | | | |
| 7. 字体一致性测试 | | | | |
| 8. 错误处理测试 | | | | |
| 9. 性能测试 | | | | |
| 10. 跨平台兼容性 | | | | |
| **总计** | | | | |

### 失败测试项记录

| 测试项 | 失败原因 | 严重程度 | 规避方式 | 状态 |
|--------|---------|---------|---------|------|
| | | | | |

### 性能数据记录

| 性能指标 | 测量值 | 目标值 | 是否达标 |
|---------|--------|--------|---------|
| 面板加载时间 | | < 3s | |
| 简单公式渲染时间 | | < 500ms | |
| 插入时间 | | < 2s | |
| 复杂公式渲染时间 | | < 5s | |

---

## 测试结论

### 总体评估

- [ ] 所有必测项通过
- [ ] 关键功能正常
- [ ] 性能符合预期
- [ ] 无阻塞性问题

### 已知问题

（记录测试中发现的已知问题）

### 建议

（记录测试中的改进建议）

---

## 附录

### 测试数据文件位置

- 测试公式集：`tests/data/phase4-test-formulas.json`
- 测试字体包：`extension/client/dist/fonts/user-font-pack/`

### 参考文档

- 需求文档：`.kiro/specs/math-formula-plugin/requirements.md`
- 设计文档：`.kiro/specs/math-formula-plugin/design.md`
- 兼容性矩阵：`docs/phase4-compatibility-matrix.md`

---

## 更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|---------|--------|
| 2026-02-24 | 1.0.0 | 初始版本，定义完整回归测试清单 | Kiro AI Agent |
