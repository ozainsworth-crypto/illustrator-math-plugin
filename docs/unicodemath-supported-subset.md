# UnicodeMath 支持子集文档

**版本**: 1.0.0  
**日期**: 2026-02-02  
**状态**: Phase 2 实现

---

## 概述

本文档定义了数学公式插件支持的 UnicodeMath 语法子集。我们的实现基于 Microsoft Office 使用的 UnicodeMath 线性格式，但仅支持最常用的数学表达式。

**目标通过率**: ≥ 80% (16/20 样例)  
**验收样例集**: `tests/spike/phase2-samples.json`

---

## 支持的语法

### 1. 分数（Fractions）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `a/b` | `\frac{a}{b}` | 简单分数 |
| `1/(2/3)` | `\frac{1}{\frac{2}{3}}` | 嵌套分数 |
| `(a+b)/c` | `\frac{a+b}{c}` | 括号分数 |

**支持程度**: ✅ 完全支持  
**测试覆盖**: 5 个测试用例

### 2. 上下标（Superscripts & Subscripts）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `x^2` | `x^{2}` | 简单上标 |
| `x_i` | `x_{i}` | 简单下标 |
| `x_i^2` | `x_{i}^{2}` | 上下标组合 |
| `x^(y^z)` | `x^{y^{z}}` | 多级上标（可能存在歧义） |

**支持程度**: ✅ 完全支持  
**歧义检测**: ✅ 支持  
**测试覆盖**: 4 个测试用例

**已知歧义**:
- `x^(y^z)` 可能被解释为 `x^{y^{z}}` 或 `(x^{y})^{z}`
- `x^2^3` 可能被解释为 `x^{2^{3}}` 或 `(x^{2})^{3}`

### 3. 根号（Roots）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `√x` | `\sqrt{x}` | 平方根 |
| `∛x` | `\sqrt[3]{x}` | 立方根 |

**支持程度**: ✅ 完全支持  
**测试覆盖**: 2 个测试用例

### 4. 求和与积分（Summation & Integration）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `∑_(i=1)^n x_i` | `\sum_{i=1}^{n} x_{i}` | 求和（上下限） |
| `∫_0^∞ f(x) dx` | `\int_{0}^{\infty} f(x) dx` | 积分（上下限） |
| `lim_(x→∞)` | `\lim_{x \to \infty}` | 极限 |

**支持程度**: ✅ 完全支持  
**测试覆盖**: 3 个测试用例

### 5. 括号伸缩（Stretchy Brackets）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `(a/b)` | `\left(\frac{a}{b}\right)` | 自动伸缩圆括号 |
| `[(a+b)/c]` | `\left[\frac{a+b}{c}\right]` | 自动伸缩方括号 |

**支持程度**: ✅ 智能判断  
**说明**: 仅当括号内包含 `\frac`, `\sum`, `\int`, `\sqrt` 等大型结构时才添加 `\left` `\right`  
**测试覆盖**: 3 个测试用例

### 6. 矩阵（Matrices）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `■(a&b@c&d)` | `\begin{matrix} a & b \\ c & d \end{matrix}` | 2×2 矩阵 |

**支持程度**: ✅ 基础支持  
**说明**: 
- `■` 是 UnicodeMath 矩阵符号
- `&` 表示列分隔
- `@` 表示换行

**测试覆盖**: 1 个测试用例

### 7. 希腊字母（Greek Letters）

| Unicode | LaTeX | Unicode | LaTeX |
|---------|-------|---------|-------|
| `α` | `\alpha` | `ν` | `\nu` |
| `β` | `\beta` | `ξ` | `\xi` |
| `γ` | `\gamma` | `π` | `\pi` |
| `δ` | `\delta` | `ρ` | `\rho` |
| `ε` | `\epsilon` | `σ` | `\sigma` |
| `θ` | `\theta` | `τ` | `\tau` |
| `λ` | `\lambda` | `φ` | `\phi` |
| `μ` | `\mu` | `ω` | `\omega` |

**支持程度**: ✅ 完全支持  
**测试覆盖**: 2 个测试用例

### 8. 运算符（Operators）

| Unicode | LaTeX | 说明 |
|---------|-------|------|
| `≤` | `\leq` | 小于等于 |
| `≥` | `\geq` | 大于等于 |
| `≠` | `\neq` | 不等于 |
| `≈` | `\approx` | 约等于 |
| `×` | `\times` | 乘号 |
| `÷` | `\div` | 除号 |
| `→` | `\to` | 箭头 |
| `∞` | `\infty` | 无穷 |

**支持程度**: ✅ 完全支持  
**测试覆盖**: 2 个测试用例

### 9. 多行对齐（Multiline Alignment）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `■(x=1@y=2)` | `\begin{aligned} x &= 1 \\ y &= 2 \end{aligned}` | 多行对齐 |

**支持程度**: ✅ 基础支持  
**说明**: 自动在等号前添加对齐符号 `&=`  
**测试覆盖**: 1 个测试用例

### 10. 函数名（Function Names）

| UnicodeMath | LaTeX | 说明 |
|-------------|-------|------|
| `sin(x)` | `\sin(x)` | 三角函数 |
| `cos(x)` | `\cos(x)` | 三角函数 |
| `tan(x)` | `\tan(x)` | 三角函数 |
| `log(x)` | `\log(x)` | 对数函数 |
| `ln(x)` | `\ln(x)` | 自然对数 |
| `exp(x)` | `\exp(x)` | 指数函数 |

**支持程度**: ✅ 完全支持  
**测试覆盖**: 3 个测试用例

---

## 不支持的语法

以下 UnicodeMath 语法当前**不支持**，会触发降级提示：

### 1. 高级矩阵功能

- ❌ 3×3 或更大的矩阵
- ❌ 带括号的矩阵（`pmatrix`, `bmatrix` 等）
- ❌ 矩阵元素对齐控制

**降级建议**: 使用 LaTeX 语法或 AsciiMath

### 2. 复杂的多行结构

- ❌ `cases` 环境
- ❌ 自定义对齐点
- ❌ 多列对齐

**降级建议**: 使用 LaTeX 语法

### 3. 特殊符号与装饰

- ❌ 上划线、下划线（`\overline`, `\underline`）
- ❌ 箭头装饰（`\vec`, `\hat`）
- ❌ 括号装饰（`\overbrace`, `\underbrace`）

**降级建议**: 使用 LaTeX 语法

### 4. 高级数学结构

- ❌ 多重积分（`\iint`, `\iiint`）
- ❌ 环路积分（`\oint`）
- ❌ 偏导数符号（`\partial`）
- ❌ 梯度、散度、旋度符号

**降级建议**: 使用 LaTeX 语法

### 5. 自定义间距与格式

- ❌ 手动间距控制（`\quad`, `\,` 等）
- ❌ 字体控制（`\mathbf`, `\mathit` 等）
- ❌ 颜色控制

**降级建议**: 使用 LaTeX 语法

---

## 降级策略

当遇到不支持的 UnicodeMath 语法时，系统会按以下顺序降级：

1. **UnicodeMath 子集解析** → 尝试解析支持的子集
2. **AsciiMath 兜底** → 使用 Plurimath 尝试 AsciiMath 解析
3. **人工选择界面** → 弹出格式选择器，允许用户切换到 LaTeX 或手动编辑
4. **降级提示** → 显示错误类型、失败原因和操作建议

详见：`docs/fallback-chain-rules.md`

---

## 歧义处理

### 自动检测的歧义类型

1. **多级上标歧义**: `x^(y^z)` 
   - 解释 A: `x^{y^{z}}` (默认)
   - 解释 B: `(x^{y})^{z}`

2. **连续上标歧义**: `x^2^3`
   - 解释 A: `x^{2^{3}}` (默认)
   - 解释 B: `(x^{2})^{3}`

3. **括号优先级歧义**: 复杂的括号嵌套
   - 系统会标记为歧义，但不提供替代解析

### 歧义解决流程

1. **自动评分**: AmbiguityScorer 计算置信度
2. **自动选择**: 如果置信度差异 > 阈值，自动选择最高分
3. **人工选择**: 否则弹出对比界面，显示多种解析结果的 SVG 预览

详见：`src/lib/ambiguity-scorer.ts` (待实现)

---

## 性能保护

为防止解析器阻塞主线程，实施以下保护措施：

- **输入长度限制**: 最大 10,000 字符
- **解析超时**: 5 秒超时
- **性能监控**: 记录每次解析耗时和输入长度

超时或超长输入会触发降级提示。

详见：`docs/performance-optimization-risks.md` (待创建)

---

## 测试覆盖

| 类别 | 测试用例数 | 通过率 |
|------|-----------|--------|
| 基础功能 | 2 | 100% |
| 分数解析 | 5 | 100% |
| 上下标解析 | 4 | 100% |
| 根号解析 | 2 | 100% |
| 括号伸缩 | 3 | 100% |
| 求和/积分 | 2 | 100% |
| 矩阵解析 | 1 | 100% |
| 希腊字母 | 2 | 100% |
| 运算符 | 2 | 100% |
| 多行解析 | 1 | 100% |
| 函数名 | 3 | 100% |
| 组合表达式 | 3 | 100% |
| 歧义检测 | 4 | 100% |
| **总计** | **34** | **100%** |

**20 条样例验收集**: 待运行 `tests/examples/phase2-samples.test.ts`

---

## 使用示例

### 简单表达式

```
输入: a/b + √x
输出: \frac{a}{b} + \sqrt{x}
```

### 复杂表达式

```
输入: f(x)=(∑_(i=1)^n x_i^2)/√n
输出: f(x)=\frac{\sum_{i=1}^{n} x_{i}^{2}}{\sqrt{n}}
```

### 歧义表达式

```
输入: x^(y^z)
输出: x^{y^{z}} (默认)
歧义: 是
替代: (x^{y})^{z}
```

---

## 更新日志

### v1.0.0 (2026-02-02)

- ✅ 实现 10 大类 UnicodeMath 语法支持
- ✅ 实现歧义检测与标记
- ✅ 实现智能括号伸缩
- ✅ 单元测试覆盖率 100% (34/34)
- ⏳ 待实现：20 条样例验收测试
- ⏳ 待实现：AmbiguityScorer 组件
- ⏳ 待实现：性能保护措施

---

## 参考资料

- [UnicodeMath 官方规范](https://www.unicode.org/notes/tn28/)
- [Microsoft Office UnicodeMath](https://docs.microsoft.com/en-us/typography/opentype/spec/math)
- [Phase 2 Spike 报告](../tests/spike/phase2-spike-report.md)
- [Phase 2 实施策略](../tests/spike/phase2-implementation-strategy.md)

---

**文档维护**: 随着功能迭代，本文档将持续更新。
